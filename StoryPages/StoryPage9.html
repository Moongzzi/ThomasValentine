<!DOCTYPE html>
<html lang="ko">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Valentine Story 9</title>
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@400;700&family=Noto+Sans+KR:wght@400;600&display=swap"
			rel="stylesheet"
		/>
		<link rel="stylesheet" href="../styles/story-common.css" />
		<link rel="stylesheet" href="../styles/story-page9.css" />
	</head>
	<body>
		<img class="corner-logo" src="../images/ValentineLogo.png" alt="Valentine logo" />
		<div class="bgm-control">
			<div class="bgm-row">
				<span class="bgm-label">BGM</span>
				<input
					id="bgm-volume"
					type="range"
					min="0"
					max="1"
					step="0.01"
					aria-label="배경음악 볼륨"
				/>
			</div>
			<div class="bgm-row">
				<span class="bgm-label">SE</span>
				<input
					id="se-volume"
					type="range"
					min="0"
					max="1"
					step="0.01"
					aria-label="효과음 볼륨"
				/>
			</div>
		</div>
		<div class="page-number" aria-label="페이지 9/9">9 / 9</div>
		<main class="stage" id="stage" aria-live="polite"></main>
		<script src="../scripts/story-common.js"></script>
		<script>
			const lines = [
				"놀이터에 도착해서 이름을 불러달라고 했으니까..",
				"",
				"이제 내가 생각한 그 사람이 맞는지 이름을 불러봐야겠다.."
			];
			const voiceClips = [
				"../music/SE/Boy_Dialogue/Boy_9-1.m4a",
				"../music/SE/Boy_Dialogue/Boy_9-2.m4a"
			];

			const stage = document.getElementById("stage");
			const { hintDelayMs, readyPromise } = window.StoryPage.renderLines(stage, {
				lines,
				voiceClips
			});

			const answerRow = document.createElement("div");
			answerRow.className = "answer-row fade-panel";
			const helpButton = document.createElement("button");
			helpButton.className = "help-button";
			helpButton.type = "button";
			helpButton.textContent = "?";
			helpButton.setAttribute("aria-label", "정답 입력 도움말");
			helpButton.setAttribute("data-tooltip", "찾아낸 단서를 그대로 입력해주세요.");
			const answerField = document.createElement("input");
			answerField.className = "answer-field";
			answerField.type = "text";
			answerField.placeholder = "정답을 입력하세요";
			answerField.setAttribute("aria-label", "정답 입력");
			const answerButton = document.createElement("button");
			answerButton.className = "answer-button";
			answerButton.type = "button";
			answerButton.textContent = "정답 입력";
			answerRow.appendChild(helpButton);
			answerRow.appendChild(answerField);
			answerRow.appendChild(answerButton);

			const secondaryActions = document.createElement("div");
			secondaryActions.className = "secondary-actions fade-panel";
			const letterButton = document.createElement("button");
			letterButton.className = "secondary-button";
			letterButton.type = "button";
			letterButton.textContent = "편지 다시보기";
			secondaryActions.appendChild(letterButton);

			const imageModal = document.createElement("div");
			imageModal.className = "image-modal";
			imageModal.setAttribute("aria-hidden", "true");
			const modalImage = document.createElement("img");
			modalImage.src = "../images/ValentineQuiz2.png";
			modalImage.alt = "편지 다시보기";
			imageModal.appendChild(modalImage);
			document.body.appendChild(imageModal);

			const openModal = () => {
				imageModal.classList.add("show");
				imageModal.setAttribute("aria-hidden", "false");
			};

			const closeModal = () => {
				imageModal.classList.remove("show");
				imageModal.setAttribute("aria-hidden", "true");
			};

			const toggleHelp = () => {
				const isOpen = helpButton.classList.toggle("is-open");
				helpButton.setAttribute("aria-expanded", String(isOpen));
			};

			const closeHelp = () => {
				if (!helpButton.classList.contains("is-open")) {
					return;
				}
				helpButton.classList.remove("is-open");
				helpButton.setAttribute("aria-expanded", "false");
			};

			const showDelayMs = window.StoryPage.prefersReducedMotion.matches ? 0 : hintDelayMs;
			Promise.all([readyPromise, new Promise((resolve) => window.setTimeout(resolve, showDelayMs))]).then(() => {
				if (!answerRow.isConnected) {
					stage.appendChild(answerRow);
				}
				if (!secondaryActions.isConnected) {
					stage.appendChild(secondaryActions);
				}
				answerRow.classList.add("show");
				secondaryActions.classList.add("show");
			});

			const checkAnswer = () => {
				const value = answerField.value.trim().toLowerCase();
				if (value === "iamok") {
					window.location.href = "SuccessStoryPage.html";
					return;
				}
				window.location.href = "FailStoryPage.html";
			};

			answerButton.addEventListener("click", checkAnswer);
			answerField.addEventListener("keydown", (event) => {
				if (event.key === "Enter") {
					checkAnswer();
				}
			});
			letterButton.addEventListener("click", openModal);
			imageModal.addEventListener("click", closeModal);
			helpButton.addEventListener("click", (event) => {
				event.stopPropagation();
				toggleHelp();
			});
			document.addEventListener("click", (event) => {
				if (!helpButton.contains(event.target)) {
					closeHelp();
				}
			});
			document.addEventListener("keydown", (event) => {
				if (event.key === "Escape") {
					closeModal();
				}
			});
		</script>
		<script src="../scripts/bgm.js" data-bgm-src="../music/BGM/BackgroundMusic.mp3"></script>
	</body>
</html>
